<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>StellarPopulationModel &#8212; pySU, python Skies and Universes 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pySU, python Skies and Universes 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>pySU, python Skies and Universes 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>StellarPopulationModel</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for StellarPopulationModel</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. moduleauthor:: Johan Comparat &lt;johan.comparat__at__gmail.com&gt;</span>

<span class="sd">General purpose:</span>
<span class="sd">................</span>

<span class="sd">The class StellarPopulationModel is a wrapper dedicated to handling the fit of stellar population models on observed spectra. </span>
<span class="sd">It gathers all inputs : from the model and from the data.</span>

<span class="sd">*Imports*::</span>

<span class="sd">	import numpy as np</span>
<span class="sd">	import astropy.io.fits as pyfits</span>
<span class="sd">	import astropy.units as u</span>
<span class="sd">	import glob</span>
<span class="sd">	import pandas as pd</span>
<span class="sd">	import os</span>
<span class="sd">	from firefly_instrument import *</span>
<span class="sd">	from firefly_dust import *</span>
<span class="sd">	from firefly_fitter import *</span>
<span class="sd">	from firefly_library import *</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="c1">#from scipy.stats import sigmaclip</span>

<span class="c1">#from firefly_dust import *</span>
<span class="c1">#import firefly_dust as f_dust</span>
<span class="kn">from</span> <span class="nn">firefly_dust</span> <span class="k">import</span> <span class="n">hpf</span><span class="p">,</span> <span class="n">unred</span><span class="p">,</span> <span class="n">determine_attenuation</span>
<span class="kn">from</span> <span class="nn">firefly_instrument</span> <span class="k">import</span> <span class="n">downgrade</span> 
<span class="kn">from</span> <span class="nn">firefly_fitter</span> <span class="k">import</span> <span class="n">fitter</span>
<span class="kn">from</span> <span class="nn">firefly_library</span> <span class="k">import</span> <span class="n">airtovac</span><span class="p">,</span> <span class="n">convert_chis_to_probs</span><span class="p">,</span> <span class="n">light_weights_to_mass</span><span class="p">,</span> <span class="n">calculate_averages_pdf</span><span class="p">,</span> <span class="n">normalise_spec</span><span class="p">,</span> <span class="n">match_data_models</span>


<div class="viewcode-block" id="StellarPopulationModel"><a class="viewcode-back" href="../StellarPopulationModel.html#StellarPopulationModel.StellarPopulationModel">[docs]</a><span class="k">class</span> <span class="nc">StellarPopulationModel</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	:param specObs: specObs observed spectrum object initiated with the  GalaxySpectrumFIREFLY class.</span>
<span class="sd">	:param models: choose between &#39;m11&#39;, &#39;bc03&#39; or &#39;m09&#39;. </span>

<span class="sd">		* m11 corresponds to all the models compared in `Maraston and Stromback 2011  &lt;http://adsabs.harvard.edu/abs/2011MNRAS.418.2785M&gt;`_. </span>
<span class="sd">		* m09 to `Maraston et al. 2009 &lt;http://adsabs.harvard.edu/abs/2009A%26A...493..425M&gt;`_. </span>
<span class="sd">		* bc03 to the `Bruzual and Charlot 2003 models &lt;http://adsabs.harvard.edu/abs/2003MNRAS.344.1000B&gt;`_.</span>

<span class="sd">	:param model_libs: only necessary if using m11. </span>
<span class="sd">	Choose between `MILES &lt;http://adsabs.harvard.edu/abs/2011A%26A...532A..95F&gt;`_, MILES revisednearIRslope, MILES UVextended, `STELIB &lt;http://adsabs.harvard.edu/abs/2003A%26A...402..433L&gt;`_, `ELODIE &lt;http://adsabs.harvard.edu/abs/2007astro.ph..3658P&gt;`_, `MARCS &lt;http://adsabs.harvard.edu/abs/2008A%26A...486..951G&gt;`_. </span>

<span class="sd">		* MILES, MILES revisednearIRslope, MILES UVextended, STELIB, ELODIE are empirical libraries. </span>
<span class="sd">		* MARCS is a theoretical library.</span>

<span class="sd">	:param imfs: choose the `initial mass function &lt;https://en.wikipedia.org/wiki/Initial_mass_function&gt;`_:</span>

<span class="sd">		* &#39;ss&#39; for `Salpeter &lt;http://adsabs.harvard.edu/abs/1955ApJ...121..161S&gt;`_or </span>
<span class="sd">		* &#39;kr&#39; for `Kroupa &lt;http://adsabs.harvard.edu/cgi-bin/bib_query?arXiv:1112.3340&gt;`_ or </span>
<span class="sd">		* &#39;cha&#39; for `Chabrier &lt;http://adsabs.harvard.edu/abs/2003PASP..115..763C&gt;`_.</span>

<span class="sd">	 Notes</span>
<span class="sd">	 -----</span>

<span class="sd">	.. note::</span>
<span class="sd">		*This is how it proceeds :*</span>
<span class="sd">		 #. reads the parameter file by using parameters_obtain(parameters.py)</span>
<span class="sd">		 #. It opens the data file, model files, then it matches their resolutions by downgrading the models to instrumental and velocity dispersion resolution</span>
<span class="sd">		 #. Determines dust attenuation curve to be applied to the models. Two options : through HPF fitting (3.1.) or through filtered values to determing SP properties (3.2.).</span>
<span class="sd">		 #. It fits the models to the data</span>
<span class="sd">		 #. Gets mass-weighted SSP contributions using saved M/L ratio.</span>
<span class="sd">		 #. Convert chis into probabilities and calculates all average properties and errors (assuming the number of degrees of freedom is the number of wavelength points)</span>
<span class="sd">		 #. Optionally produces a plot</span>
<span class="sd">		 #. Finally, it writes the output files</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specObs</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">models</span> <span class="o">=</span> <span class="s1">&#39;m11&#39;</span><span class="p">,</span> <span class="n">model_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MILES_UVextended&#39;</span><span class="p">],</span> <span class="n">imfs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span><span class="s1">&#39;kr&#39;</span><span class="p">],</span> <span class="n">hpf_mode</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">age_limits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mf">10.1</span><span class="p">],</span> <span class="n">downgrade_models</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dust_law</span> <span class="o">=</span> <span class="s1">&#39;calzetti&#39;</span><span class="p">,</span> <span class="n">max_ebv</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">num_dust_vals</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">dust_smoothing_length</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fit_per_iteration_cap</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">pdf_sampling</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">data_wave_medium</span> <span class="o">=</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">,</span> <span class="n">Z_limits</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">wave_limits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">99999990</span><span class="p">],</span> <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;-fireflyFits.fits&quot;</span><span class="p">,</span><span class="n">use_downgraded_models</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmo</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">specObs</span> <span class="o">=</span> <span class="n">specObs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>
		<span class="c1">#################### STARTS HERE #################### </span>
		<span class="c1"># sets the models</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span> <span class="c1"># m11/bc03 / m09</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model_libs</span> <span class="o">=</span> <span class="n">model_libs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">vdisp_round</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">vdisp</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span><span class="o">*</span><span class="mf">5.0</span><span class="p">)</span> <span class="c1"># rounding vDisp for the models</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">use_downgraded_models</span> <span class="o">=</span> <span class="n">use_downgraded_models</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">==</span> <span class="s1">&#39;m11&#39;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_libs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;MILES&#39;</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;MILES_revisednearIRslope&#39;</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;MILES_UVextended&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">2.55</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;STELIB&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">3.40</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;ELODIE&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.55</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;MARCS&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">==</span><span class="s1">&#39;bc03&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">model_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STELIB_BC03&#39;</span><span class="p">]</span>
			<span class="n">imfs</span>        <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.00</span><span class="p">]</span>

		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">==</span> <span class="s1">&#39;m09&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">model_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;M09&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">downgrade_models</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.6</span><span class="p">]</span>
		<span class="c1"># sets the Initial mass function</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">imfs</span> <span class="o">=</span> <span class="n">imfs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hpf_mode</span> <span class="o">=</span> <span class="n">hpf_mode</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span> <span class="o">=</span> <span class="n">age_limits</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">downgrade_models</span> <span class="o">=</span> <span class="n">downgrade_models</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dust_law</span> <span class="o">=</span> <span class="n">dust_law</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_ebv</span> <span class="o">=</span> <span class="n">max_ebv</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">num_dust_vals</span> <span class="o">=</span> <span class="n">num_dust_vals</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dust_smoothing_length</span> <span class="o">=</span> <span class="n">dust_smoothing_length</span>
		<span class="c1"># Specific fitting options</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fit_per_iteration_cap</span> <span class="o">=</span> <span class="n">fit_per_iteration_cap</span>
		<span class="c1"># Sampling size when calculating the maximum pdf (100=recommended)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pdf_sampling</span> <span class="o">=</span> <span class="n">pdf_sampling</span>
		<span class="c1"># Default is air, unless manga is used</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data_wave_medium</span> <span class="o">=</span> <span class="n">data_wave_medium</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span> <span class="o">=</span> <span class="n">Z_limits</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">wave_limits</span> <span class="o">=</span> <span class="n">wave_limits</span>

<div class="viewcode-block" id="StellarPopulationModel.get_model"><a class="viewcode-back" href="../StellarPopulationModel.html#StellarPopulationModel.StellarPopulationModel.get_model">[docs]</a>	<span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_used</span><span class="p">,</span> <span class="n">imf_used</span><span class="p">,</span> <span class="n">deltal</span><span class="p">,</span> <span class="n">vdisp</span><span class="p">,</span> <span class="n">wave_instrument</span><span class="p">,</span> <span class="n">r_instrument</span><span class="p">,</span> <span class="n">ebv_mw</span><span class="p">):</span>

		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Retrieves all relevant model files, in their downgraded format.</span>
<span class="sd">		If they aren&#39;t downgraded to the correct resolution / velocity dispersion,</span>
<span class="sd">		takes the base models in their native form and converts to downgraded files.</span>

<span class="sd">		:param model_used: list of models to be used, for example [&#39;m11&#39;, &#39;m09&#39;].</span>
<span class="sd">		:param imf_used: list of imf to be used, for example [&#39;ss&#39;, &#39;cha&#39;].</span>
<span class="sd">		:param deltal: delta lambda in the models.</span>
<span class="sd">		:param vdisp: velocity dispersion observed in the galaxy.</span>
<span class="sd">		:param wave_instrument: wavelength array from the observations</span>
<span class="sd">		:param r_instrument: resolution array from the observations</span>
<span class="sd">		:param  ebv_mw: E(B-V) from the dust maps for the galaxy.</span>
<span class="sd">		</span>
<span class="sd">		Workflow</span>
<span class="sd">		----------		</span>
<span class="sd">			A. loads the models m11 or m09: maps parameters to the right files. Then it constructs the model array. Finally converts wavelengths to air or vacuum.</span>
<span class="sd">			B. downgrades the model to match data resolution</span>
<span class="sd">			C. applies attenuation</span>
<span class="sd">			D. stores models in </span>
<span class="sd">				self.model_wavelength, </span>
<span class="sd">				self.model_flux, </span>
<span class="sd">				self.age_model, </span>
<span class="sd">				self.metal_model </span>
<span class="sd">			</span>
<span class="sd">			and returns it as well</span>
<span class="sd">			</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># first the m11 case</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">==</span> <span class="s1">&#39;m11&#39;</span><span class="p">:</span>
			<span class="n">first_file</span>  <span class="o">=</span> <span class="kc">True</span> 
			<span class="n">model_files</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_downgraded_models</span> <span class="p">:</span>
				<span class="k">if</span> <span class="n">model_used</span> <span class="o">==</span> <span class="s1">&#39;MILES_UVextended&#39;</span> <span class="ow">or</span> <span class="n">model_used</span> <span class="o">==</span> <span class="s1">&#39;MILES_revisedIRslope&#39;</span><span class="p">:</span>
					<span class="n">model_path</span> 		<span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;SSP_M11_MILES_downgraded&#39;</span><span class="p">,</span><span class="s1">&#39;ssp_M11_&#39;</span> <span class="o">+</span> <span class="n">model_used</span><span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">imf_used</span><span class="p">)</span>				
				<span class="k">else</span><span class="p">:</span>
					<span class="n">model_path</span> 		<span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;SSP_M11_&#39;</span><span class="o">+</span> <span class="n">model_used</span> <span class="o">+</span> <span class="s1">&#39;_downgraded&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp_M11_&#39;</span> <span class="o">+</span><span class="n">model_used</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">imf_used</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">model_used</span> <span class="o">==</span> <span class="s1">&#39;MILES_UVextended&#39;</span> <span class="ow">or</span> <span class="n">model_used</span> <span class="o">==</span> <span class="s1">&#39;MILES_revisedIRslope&#39;</span><span class="p">:</span>
					<span class="n">model_path</span> 		<span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;SSP_M11_MILES&#39;</span><span class="p">,</span> <span class="s1">&#39;ssp_M11_&#39;</span><span class="o">+</span><span class="n">model_used</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">imf_used</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">model_path</span> 		<span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;SSP_M11_&#39;</span><span class="o">+</span><span class="n">model_used</span> <span class="p">,</span><span class="s1">&#39;ssp_M11_&#39;</span> <span class="o">+</span><span class="n">model_used</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">imf_used</span><span class="p">)</span>

			<span class="c1"># Constructs the metallicity array of models :</span>
			<span class="n">all_metal_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">model_path</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
			<span class="c1">#print all_metal_files</span>
			<span class="n">metal_files</span> 	<span class="o">=</span> <span class="p">[]</span>
			<span class="n">metal</span> 	    <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_metal_files</span><span class="p">)):</span>
				<span class="n">zchar</span> <span class="o">=</span> <span class="n">all_metal_files</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">model_path</span><span class="p">):]</span>
				<span class="k">if</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z001&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.3</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z002&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z004&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="mf">0.3</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z0001.bhb&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.301</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z0001.rhb&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.302</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z10m4.bhb&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.301</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z10m4.rhb&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.302</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z10m4&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.300</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Unrecognised metallicity! Check model file names.&#39;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">znum</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">znum</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
					<span class="n">metal_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_metal_files</span><span class="p">[</span><span class="n">z</span><span class="p">])</span>
					<span class="n">metal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">znum</span><span class="p">)</span>
			<span class="c1"># constructs the model array</span>
			<span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span> <span class="o">=</span> <span class="p">[],[],[]</span>
			<span class="k">for</span> <span class="n">zi</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metal_files</span><span class="p">):</span>
				<span class="nb">print</span> <span class="s2">&quot;Retrieving and downgrading models for &quot;</span><span class="o">+</span><span class="n">z</span>
				<span class="n">model_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Age&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">},</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span><span class="s1">&#39;wavelength_model&#39;</span><span class="p">,</span><span class="s1">&#39;flux_model&#39;</span><span class="p">],</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">age_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_table</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
				<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">age_data</span><span class="p">:</span>
					<span class="n">logyrs_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mf">9.0</span>
					<span class="c1">#print &quot;age model selection:&quot;, self.age_limits[0], logyrs_a, self.age_limits[1]</span>
					<span class="k">if</span> <span class="n">logyrs_a</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">logyrs_a</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
						<span class="k">continue</span>

					<span class="n">spectrum</span> <span class="o">=</span> <span class="n">model_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_table</span><span class="o">.</span><span class="n">Age</span> <span class="o">==</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;wavelength_model&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_model&#39;</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span>
					<span class="n">wavelength_int</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">spectrum</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

					<span class="c1"># converts to air wavelength</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_wave_medium</span> <span class="o">==</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">:</span>
						<span class="n">wavelength</span> <span class="o">=</span> <span class="n">airtovac</span><span class="p">(</span><span class="n">wavelength_int</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength_int</span>

					<span class="c1"># downgrades the model</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downgrade_models</span><span class="p">:</span>
						<span class="n">mf</span> <span class="o">=</span> <span class="n">downgrade</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">deltal</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vdisp_round</span><span class="p">,</span> <span class="n">wave_instrument</span><span class="p">,</span> <span class="n">r_instrument</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">mf</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>			
			
					<span class="c1"># Reddens the models</span>
					<span class="k">if</span> <span class="n">ebv_mw</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">attenuations</span> <span class="o">=</span> <span class="n">unred</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">ebv</span><span class="o">=</span><span class="mf">0.0</span><span class="o">-</span><span class="n">ebv_mw</span><span class="p">)</span>
						<span class="n">model_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="o">*</span><span class="n">attenuations</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">model_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>

					<span class="n">age_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
					<span class="n">metal_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metal</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span>
					<span class="n">first_model</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="nb">print</span> <span class="s2">&quot;Retrieved all models!&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">model_wavelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_model</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span>
			<span class="k">return</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span>

		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">==</span> <span class="s1">&#39;m09&#39;</span><span class="p">:</span>
			<span class="n">first_file</span>  <span class="o">=</span> <span class="kc">True</span> 
			<span class="n">model_files</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_downgraded_models</span><span class="p">:</span>
				<span class="n">model_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;UVmodels_Marastonetal08b_downgraded&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">model_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STELLARPOPMODELS_DIR&#39;</span><span class="p">],</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;UVmodels_Marastonetal08b&#39;</span><span class="p">)</span>
			<span class="c1"># Gathers the list of models with metallicities and ages of interest:</span>
			<span class="n">all_metal_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">model_path</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
			<span class="n">metal_files</span> 	<span class="o">=</span> <span class="p">[]</span>
			<span class="n">metal</span> 			<span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_metal_files</span><span class="p">)):</span>
				<span class="n">zchar</span> <span class="o">=</span> <span class="n">all_metal_files</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
				<span class="k">if</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z001&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.3</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z002&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z004&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="mf">0.3</span>
				<span class="k">elif</span> <span class="n">zchar</span> <span class="o">==</span> <span class="s1">&#39;z0001&#39;</span><span class="p">:</span>
					<span class="n">znum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.300</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Unrecognised metallicity! Check model file names.&#39;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">znum</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">znum</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
					<span class="n">metal_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_metal_files</span><span class="p">[</span><span class="n">z</span><span class="p">])</span>
					<span class="n">metal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">znum</span><span class="p">)</span>

			<span class="c1"># constructs the model array</span>
			<span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span> <span class="o">=</span> <span class="p">[],[],[]</span>
			<span class="k">for</span> <span class="n">zi</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metal_files</span><span class="p">):</span>
				<span class="nb">print</span> <span class="s2">&quot;Retrieving and downgrading models for &quot;</span><span class="o">+</span><span class="n">z</span>
				<span class="n">model_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Age&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">},</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span><span class="s1">&#39;wavelength_model&#39;</span><span class="p">,</span><span class="s1">&#39;flux_model&#39;</span><span class="p">],</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">age_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_table</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
				<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">age_data</span><span class="p">:</span>
					<span class="n">logyrs_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mf">9.0</span>
					<span class="c1">#print &quot;age model selection:&quot;, self.age_limits[0], logyrs_a, self.age_limits[1]</span>
					<span class="k">if</span> <span class="n">logyrs_a</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">logyrs_a</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
						<span class="k">continue</span>

					<span class="n">spectrum</span> <span class="o">=</span> <span class="n">model_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">model_table</span><span class="o">.</span><span class="n">Age</span> <span class="o">==</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;wavelength_model&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_model&#39;</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span>
					<span class="n">wavelength_int</span><span class="p">,</span><span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">spectrum</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

					<span class="c1"># converts to air wavelength</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_wave_medium</span> <span class="o">==</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">:</span>
						<span class="n">wavelength</span> <span class="o">=</span> <span class="n">airtovac</span><span class="p">(</span><span class="n">wavelength_int</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength_int</span>

					<span class="c1"># downgrades the model</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downgrade_models</span><span class="p">:</span>
						<span class="n">mf</span> <span class="o">=</span> <span class="n">downgrade</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">deltal</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vdisp_round</span><span class="p">,</span> <span class="n">wave_instrument</span><span class="p">,</span> <span class="n">r_instrument</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">mf</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>			
			
					<span class="c1"># Reddens the models</span>
					<span class="k">if</span> <span class="n">ebv_mw</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">attenuations</span> <span class="o">=</span> <span class="n">unred</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">ebv</span><span class="o">=</span><span class="mf">0.0</span><span class="o">-</span><span class="n">ebv_mw</span><span class="p">)</span>
						<span class="n">model_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="o">*</span><span class="n">attenuations</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">model_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>

					<span class="n">age_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
					<span class="n">metal_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metal</span><span class="p">[</span><span class="n">zi</span><span class="p">])</span>
					<span class="n">first_model</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="nb">print</span> <span class="s2">&quot;Retrieved all models!&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">model_wavelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_model</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span>
			<span class="k">return</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="n">age_model</span><span class="p">,</span> <span class="n">metal_model</span></div>


<div class="viewcode-block" id="StellarPopulationModel.fit_models_to_data"><a class="viewcode-back" href="../StellarPopulationModel.html#StellarPopulationModel.StellarPopulationModel.fit_models_to_data">[docs]</a>	<span class="k">def</span> <span class="nf">fit_models_to_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Once the data and models are loaded, then execute this function to find the best model. It loops overs the models to be fitted on the data:</span>
<span class="sd">		 #. gets the models</span>
<span class="sd">		 #. matches the model and data to the same resolution</span>
<span class="sd">		 #. normalises the spectra</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">mi</span><span class="p">,</span><span class="n">mm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_libs</span><span class="p">):</span>
			<span class="c1"># loop over the models</span>
			<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imfs</span><span class="p">:</span>
				<span class="c1"># loop over the IMFs</span>
				<span class="c1"># A. gets the models</span>
				<span class="nb">print</span> <span class="s2">&quot;getting the models&quot;</span>
				<span class="n">deltal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltal_libs</span><span class="p">[</span><span class="n">mi</span><span class="p">]</span>
				<span class="n">model_wave_int</span><span class="p">,</span> <span class="n">model_flux_int</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">metal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">deltal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">vdisp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">restframe_wavelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">r_instrument</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">ebv_mw</span><span class="p">)</span>
				<span class="c1"># B. matches the model and data to the same resolution</span>
				<span class="nb">print</span> <span class="s2">&quot;Matching models to data&quot;</span>
				<span class="n">wave</span><span class="p">,</span> <span class="n">data_flux</span><span class="p">,</span> <span class="n">error_flux</span><span class="p">,</span> <span class="n">model_flux_raw</span> <span class="o">=</span> <span class="n">match_data_models</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">restframe_wavelength</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">bad_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">model_wave_int</span><span class="p">,</span> <span class="n">model_flux_int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">saveDowngradedModel</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
				<span class="c1"># C. normalises the models to the median value of the data</span>
				<span class="nb">print</span> <span class="s2">&quot;Normalising the models&quot;</span>
				<span class="n">model_flux</span><span class="p">,</span> <span class="n">mass_factors</span> <span class="o">=</span> <span class="n">normalise_spec</span><span class="p">(</span><span class="n">data_flux</span><span class="p">,</span> <span class="n">model_flux_raw</span><span class="p">)</span>

			<span class="c1"># 3. Corrects from dust attenuation</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpf_mode</span><span class="o">==</span><span class="s1">&#39;on&#39;</span><span class="p">:</span>
				<span class="c1"># 3.1. Determining attenuation curve through HPF fitting, apply attenuation curve to models and renormalise spectra</span>
				<span class="n">best_ebv</span><span class="p">,</span> <span class="n">attenuation_curve</span> <span class="o">=</span> <span class="n">determine_attenuation</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">data_flux</span><span class="p">,</span> <span class="n">error_flux</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">metal</span><span class="p">)</span>
				<span class="n">model_flux_atten</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">model_flux_raw</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_flux_raw</span><span class="p">)):</span>
					<span class="n">model_flux_atten</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">attenuation_curve</span> <span class="o">*</span> <span class="n">model_flux_raw</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

				<span class="n">model_flux</span><span class="p">,</span> <span class="n">mass_factors</span> <span class="o">=</span> <span class="n">normalise_spec</span><span class="p">(</span><span class="n">data_flux</span><span class="p">,</span> <span class="n">model_flux_atten</span><span class="p">)</span>
				<span class="c1"># 4. Fits the models to the data</span>
				<span class="n">light_weights</span><span class="p">,</span> <span class="n">chis</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">data_flux</span><span class="p">,</span> <span class="n">error_flux</span><span class="p">,</span> <span class="n">model_flux</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
			
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpf_mode</span> <span class="o">==</span> <span class="s1">&#39;hpf_only&#39;</span><span class="p">:</span>

				<span class="c1"># 3.2. Uses filtered values to determing SP properties only.&quot;</span>
				<span class="n">smoothing_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dust_smoothing_length</span>
				<span class="n">hpf_data</span>    <span class="o">=</span> <span class="n">hpf</span><span class="p">(</span><span class="n">data_flux</span><span class="p">)</span>
				<span class="n">hpf_models</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">model_flux</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_flux</span><span class="p">)):</span>
					<span class="n">hpf_models</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpf</span><span class="p">(</span><span class="n">model_flux</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>

				<span class="n">zero_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hpf_data</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hpf_data</span><span class="p">))</span> <span class="p">)</span>
				<span class="n">hpf_data</span><span class="p">[</span><span class="n">zero_dat</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_flux</span><span class="p">)):</span>
					<span class="n">hpf_models</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">zero_dat</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="n">hpf_error</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">error_flux</span><span class="p">))</span>
				<span class="n">hpf_error</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">error_flux</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_flux</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hpf_data</span><span class="p">)</span>
				<span class="n">hpf_error</span><span class="p">[</span><span class="n">zero_dat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hpf_error</span><span class="p">)</span><span class="o">*</span><span class="mf">999999.9</span>

				<span class="n">best_ebv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
				<span class="n">hpf_models</span><span class="p">,</span><span class="n">mass_factors</span> <span class="o">=</span> <span class="n">normalise_spec</span><span class="p">(</span><span class="n">hpf_data</span><span class="p">,</span><span class="n">hpf_models</span><span class="p">)</span>
				<span class="c1"># 4. Fits the models to the data</span>
				<span class="n">light_weights</span><span class="p">,</span> <span class="n">chis</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">hpf_data</span><span class="p">,</span><span class="n">hpf_error</span><span class="p">,</span> <span class="n">hpf_models</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
			
			<span class="c1"># 5. Get mass-weighted SSP contributions using saved M/L ratio.</span>
			<span class="n">unnorm_mass</span><span class="p">,</span> <span class="n">mass_weights</span> <span class="o">=</span> <span class="n">light_weights_to_mass</span><span class="p">(</span><span class="n">light_weights</span><span class="p">,</span> <span class="n">mass_factors</span><span class="p">)</span>
			<span class="nb">print</span> <span class="s2">&quot;Fitting complete&quot;</span>


			<span class="nb">print</span> <span class="s2">&quot;Calculating average properties and outputting&quot;</span>
			<span class="c1"># 6. Convert chis into probabilities and calculates all average properties and errors</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
			<span class="n">probs</span> <span class="o">=</span> <span class="n">convert_chis_to_probs</span><span class="p">(</span><span class="n">chis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dof</span><span class="p">)</span>
			<span class="n">dist_lum</span>	<span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="p">)</span><span class="o">.</span><span class="n">value</span>
			<span class="n">averages</span> <span class="o">=</span> <span class="n">calculate_averages_pdf</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">light_weights</span><span class="p">,</span> <span class="n">mass_weights</span><span class="p">,</span> <span class="n">unnorm_mass</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">metal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_sampling</span><span class="p">,</span> <span class="n">dist_lum</span><span class="p">)</span>
			<span class="n">unique_ages</span> 				<span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
			<span class="n">marginalised_age_weights</span> 	<span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">unique_ages</span><span class="p">))</span>
			<span class="n">marginalised_age_weights_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">ua</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_ages</span><span class="p">)):</span>
				<span class="n">marginalised_age_weights</span><span class="p">[</span><span class="n">ua</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">marginalised_age_weights_int</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">age</span><span class="o">==</span><span class="n">unique_ages</span><span class="p">[</span><span class="n">ua</span><span class="p">])])</span>

			<span class="n">best_fit_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">chis</span><span class="p">)]</span>
			<span class="n">best_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">light_weights</span><span class="p">[</span><span class="n">best_fit_index</span><span class="p">],</span><span class="n">model_flux</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

			<span class="c1"># stores outputs in the object</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span> <span class="o">=</span> <span class="n">best_fit_index</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">best_fit</span> <span class="o">=</span> <span class="n">best_fit</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">model_flux</span> <span class="o">=</span> <span class="n">model_flux</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dist_lum</span> <span class="o">=</span> <span class="n">dist_lum</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metal</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mass_weights</span> <span class="o">=</span> <span class="n">mass_weights</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">light_weights</span> <span class="o">=</span> <span class="n">light_weights</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">chis</span> <span class="o">=</span> <span class="n">chis</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">unnorm_mass</span> <span class="o">=</span> <span class="n">unnorm_mass</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">wave</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">best_fit</span> <span class="o">=</span> <span class="n">best_fit</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">averages</span> <span class="o">=</span> <span class="n">averages</span>

			<span class="n">bf_mass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">bf_light</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">mass_per_ssp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unnorm_mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">bf_mass</span><span class="p">]</span><span class="o">*</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">17</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_lum</span><span class="o">**</span><span class="mf">2.0</span>
			<span class="n">age_per_ssp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">[</span><span class="n">bf_mass</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
			<span class="n">metal_per_ssp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal</span><span class="p">[</span><span class="n">bf_mass</span><span class="p">]</span>
			<span class="n">weight_mass_per_ssp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">bf_mass</span><span class="p">]</span>
			<span class="n">weight_light_per_ssp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">light_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_fit_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">bf_light</span><span class="p">]</span>
			<span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">weight_light_per_ssp</span><span class="p">)</span>

			<span class="nb">print</span> <span class="s2">&quot;M Msun&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;stellar_mass&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">])</span>
			<span class="nb">print</span> <span class="s2">&quot;age Gyr&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_age&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_age&#39;</span><span class="p">],</span> <span class="n">age_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">/</span><span class="mi">1</span><span class="n">e9</span>
			<span class="nb">print</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_metal&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_metal&#39;</span><span class="p">],</span> <span class="n">metal_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
			<span class="nb">print</span> <span class="s2">&quot;SFR Msun/yr&quot;</span><span class="p">,</span> <span class="n">mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">/</span><span class="n">age_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
			<span class="nb">print</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span> <span class="n">weight_mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
			<span class="nb">print</span> <span class="s2">&quot;wl&quot;</span><span class="p">,</span> <span class="n">weight_light_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
			<span class="nb">print</span> <span class="s2">&quot;z, age Gyr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
			
			<span class="c1"># 8. It writes the output file</span>
			<span class="n">waveCol</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Angstrom&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span> <span class="n">wave</span><span class="p">)</span>
			<span class="n">best_fitCol</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;firefly_model&quot;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;1e-17erg/s/cm2/Angstrom&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span> <span class="n">best_fit</span><span class="p">)</span>
			<span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span> <span class="n">waveCol</span><span class="p">,</span> <span class="n">best_fitCol</span><span class="p">])</span> 
			<span class="n">tbhdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
			
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_universe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="o">.</span><span class="n">age</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH redshift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">redshift</span>

			<span class="c1"># mean quantities</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_lightW_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_age&#39;</span><span class="p">])</span> 
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_lightW_mean_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_age_1_sig_plus&#39;</span><span class="p">])</span> <span class="c1"># log(Gyrs)</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_lightW_mean_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_age_1_sig_minus&#39;</span><span class="p">])</span> <span class="c1"># log(Gyrs)</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_lightW_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_metal&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_lightW_mean_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_metal_1_sig_plus&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_lightW_mean_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;light_metal_1_sig_minus&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_massW_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_age&#39;</span><span class="p">])</span> 
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_massW_mean_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_age_1_sig_plus&#39;</span><span class="p">])</span> <span class="c1"># log(Gyrs)</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_massW_mean_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_age_1_sig_minus&#39;</span><span class="p">])</span> <span class="c1"># log(Gyrs)</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_massW_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_metal&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_massW_mean_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_metal_1_sig_plus&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metallicity_massW_mean_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;mass_metal_1_sig_minus&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH EBV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_ebv</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH stellar_mass_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;stellar_mass&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH stellar_mass_mean_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;stellar_mass_1_sig_plus&#39;</span><span class="p">]</span>
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH stellar_mass_mean_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">averages</span><span class="p">[</span><span class="s1">&#39;stellar_mass_1_sig_minus&#39;</span><span class="p">]</span>
			
			<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ssp_number&#39;</span><span class="p">]</span> <span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
			<span class="c1"># quantities per SSP</span>
			<span class="k">for</span> <span class="n">iii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH stellar_mass_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">])[</span><span class="n">iii</span><span class="p">]</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH age_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">age_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">])</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH metal_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">metal_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">]</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH SFR_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">]</span><span class="o">/</span><span class="n">age_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">]</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH weightMass_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">weight_mass_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">]</span>
				<span class="n">tbhdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH weightLight_ssp_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">weight_light_per_ssp</span><span class="p">[</span><span class="n">order</span><span class="p">][</span><span class="n">iii</span><span class="p">]</span>
				
			<span class="n">prihdr</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specObs</span><span class="o">.</span><span class="n">path_to_spectrum</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;ageMin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;ageMax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;Zmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;Zmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">prihdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>

			<span class="n">thdulist</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">prihdu</span><span class="p">,</span> <span class="n">tbhdu</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="p">)</span>
			<span class="c1">#print self.outputFile + self.suffix , thdulist, thdulist[1].data, thdulist[0].header</span>
			<span class="n">thdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="p">)</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, johan comparat.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>